<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração da Pesquisa sobre Autismo</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        
        .controls {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group select {
            margin-left: 10px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .response-detail {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .detail-group {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .detail-group h4 {
            margin-top: 0;
            margin-bottom: 5px;
            color: #333;
        }
        
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            flex: 1;
            min-width: 200px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .no-data {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .password-content {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            width: 350px;
            max-width: 90%;
        }
        
        .password-field {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .chart-container {
            margin: 20px 0;
            height: 300px;
            max-width: 100%;
        }
        
        .stats-tabs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .stats-tab {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        
        .stats-tab.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
            font-weight: bold;
        }
        
        .stats-panel {
            display: none;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-top: none;
        }
        
        .stats-panel.active {
            display: block;
        }
        
        .chart-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-box {
            flex: 1;
            min-width: 300px;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .filter-stats {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .filter-stats select {
            margin-left: 10px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* Estilo adicional para tabelas de estatísticas */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        
        .stats-table th, .stats-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .stats-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        .stats-table td.count {
            text-align: center;
            font-weight: bold;
        }
        
        .stats-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .stats-table tr:hover {
            background-color: #f0f0f0;
        }
        
        .stats-panel h3 {
            margin-top: 25px;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- Modal de senha -->
    <div id="passwordModal" class="password-modal">
        <div class="password-content">
            <h3>Acesso Restrito</h3>
            <p>Digite a senha para acessar a área administrativa:</p>
            <input type="password" id="passwordInput" class="password-field" placeholder="Senha">
            <button id="submitPassword" class="btn">Entrar</button>
        </div>
    </div>

    <div class="admin-container">
        <h1>Administração da Pesquisa sobre Autismo</h1>
        <div class="role-indicator">
            <h2>Área Administrativa</h2>
            <a href="index.html" class="back-link">← Voltar para a página inicial</a>
        </div>
        
        <div id="adminContent" style="display: none;">
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-label">Total de Respostas</div>
                    <div id="totalResponses" class="stat-number">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pais</div>
                    <div id="parentsResponses" class="stat-number">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Professores</div>
                    <div id="teachersResponses" class="stat-number">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Profissionais</div>
                    <div id="professionalsResponses" class="stat-number">0</div>
                </div>
            </div>
            
            <div class="card">
                <h2>Gerenciamento de Dados</h2>
                <div class="controls">
                    <div>
                        <button id="exportCSV" class="btn btn-success">Exportar para CSV</button>
                        <button id="exportJSON" class="btn btn-success">Exportar JSON</button>
                        <button id="deleteAll" class="btn btn-danger">Excluir Todos</button>
                    </div>
                    <div class="filter-group">
                        <label>Filtrar por:</label>
                        <select id="filterType">
                            <option value="all">Todos</option>
                            <option value="parent">Pais</option>
                            <option value="teacher">Professores</option>
                            <option value="professional">Profissionais</option>
                        </select>
                    </div>
                </div>
                
                <div class="import-section" style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; border: 1px dashed #ccc;">
                    <h3>Importar Respostas</h3>
                    <p>Selecione um arquivo JSON exportado por outro administrador para importar as respostas.</p>
                    <input type="file" id="importFile" accept=".json" style="margin-bottom: 10px; width: 100%;">
                    <button id="importJSON" class="btn">Importar Respostas</button>
                </div>
                
                <div id="responsesContainer">
                    <table id="responsesTable">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Tipo</th>
                                <th>Nome</th>
                                <th>E-mail</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Os dados serão inseridos aqui -->
                        </tbody>
                    </table>
                    <div id="noData" class="no-data" style="display: none;">
                        <p>Não há respostas disponíveis.</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Estatísticas</h2>
                <div class="filter-stats">
                    <label>Filtrar por:</label>
                    <select id="statsFilterType">
                        <option value="all">Todos</option>
                        <option value="parent">Pais</option>
                        <option value="teacher">Professores</option>
                        <option value="professional">Profissionais</option>
                    </select>
                </div>
                
                <div class="stats-tabs">
                    <div class="stats-tab active" data-tab="general">Geral</div>
                    <div class="stats-tab" data-tab="profile">Perfil</div>
                    <div class="stats-tab" data-tab="development">Aprendizagem</div>
                    <div class="stats-tab" data-tab="technology">Tecnologia</div>
                    <div class="stats-tab" data-tab="needs">Necessidades</div>
                </div>
                
                <div class="stats-panels">
                    <!-- Painel de estatísticas gerais -->
                    <div class="stats-panel active" id="general-panel">
                        <h3>Distribuição de Respostas</h3>
                        <table class="stats-table" id="responsesTypeTable">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Painel de perfil -->
                    <div class="stats-panel" id="profile-panel">
                        <h3>Experiência com Autismo</h3>
                        <table class="stats-table" id="experienceTimeTable">
                            <thead>
                                <tr>
                                    <th>Tempo de Experiência</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                        </table>

                        <h3>Familiaridade com Tecnologia</h3>
                        <table class="stats-table" id="techFamiliarityTable">
                            <thead>
                                <tr>
                                    <th>Nível</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Painel de aprendizagem -->
                    <div class="stats-panel" id="development-panel">
                        <h3>Dificuldades de Aprendizagem</h3>
                        <table class="stats-table" id="learningDifficultiesTable">
                            <thead>
                                <tr>
                                    <th>Dificuldade</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                        </table>

                        <h3>Reação a Mudanças</h3>
                        <table class="stats-table" id="routineChangesTable">
                            <thead>
                                <tr>
                                    <th>Reação</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Painel de tecnologia -->
                    <div class="stats-panel" id="technology-panel">
                        <h3>Dispositivos Utilizados</h3>
                        <table class="stats-table" id="devicesTable">
                            <thead>
                                <tr>
                                    <th>Dispositivo</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                        </table>

                        <h3>Eficácia da Tecnologia</h3>
                        <table class="stats-table" id="techEfficacyTable">
                            <thead>
                                <tr>
                                    <th>Nível de Eficácia</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Painel de necessidades -->
                    <div class="stats-panel" id="needs-panel">
                        <h3>Recursos Importantes</h3>
                        <table class="stats-table" id="importantFeaturesTable">
                            <thead>
                                <tr>
                                    <th>Recurso</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                        </table>

                        <h3>Suporte Desejado</h3>
                        <table class="stats-table" id="desiredSupportTable">
                            <thead>
                                <tr>
                                    <th>Tipo de Suporte</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const passwordModal = document.getElementById('passwordModal');
            const adminContent = document.getElementById('adminContent');
            const passwordInput = document.getElementById('passwordInput');
            const submitPasswordButton = document.getElementById('submitPassword');
            
            // Mostrar modal de senha ao carregar
            passwordModal.style.display = 'flex';
            
            // Função para verificar senha
            submitPasswordButton.addEventListener('click', function() {
                const password = passwordInput.value;
                // Senha fixa para demonstração - em um ambiente real, isso deveria ser mais seguro
                if (password === 'admin123') {
                    passwordModal.style.display = 'none';
                    adminContent.style.display = 'block';
                    loadResponses('all');
                    
                    // Inicializar os gráficos estatísticos após autenticação
                    initializeStats();
                } else {
                    alert('Senha incorreta. Tente novamente.');
                }
            });
            
            // Permitir pressionar Enter no campo de senha
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitPasswordButton.click();
                }
            });
            
            // Configurar botões de exportação e importação
            document.getElementById('exportCSV').addEventListener('click', exportCSV);
            document.getElementById('exportJSON').addEventListener('click', exportJSON);
            document.getElementById('importJSON').addEventListener('click', importJSON);
            document.getElementById('deleteAll').addEventListener('click', function() {
                // Confirmação mais rigorosa para excluir todos os dados
                const confirmText = prompt('Esta ação excluirá TODAS as respostas. Digite "CONFIRMAR" (em maiúsculas) para prosseguir:');
                if (confirmText === 'CONFIRMAR') {
                    localStorage.removeItem('autismSurveyResponses');
                    loadResponses('all');
                    updateAllStats('all');
                    alert('Todas as respostas foram excluídas com sucesso.');
                } else {
                    alert('Operação cancelada. Nenhuma resposta foi excluída.');
                }
            });
            
            // Filtrar respostas quando mudar a seleção
            document.getElementById('filterType').addEventListener('change', function() {
                loadResponses(this.value);
            });
            
            // Função para carregar respostas
            function loadResponses(filterType) {
                let responses = JSON.parse(localStorage.getItem('autismSurveyResponses') || '[]');
                
                // Filtrar por tipo, se necessário
                if (filterType !== 'all') {
                    responses = responses.filter(r => r.formType === filterType);
                }
                
                // Atualizar contadores
                document.getElementById('totalResponses').textContent = JSON.parse(localStorage.getItem('autismSurveyResponses') || '[]').length;
                document.getElementById('parentsResponses').textContent = JSON.parse(localStorage.getItem('autismSurveyResponses') || '[]').filter(r => r.formType === 'parent').length;
                document.getElementById('teachersResponses').textContent = JSON.parse(localStorage.getItem('autismSurveyResponses') || '[]').filter(r => r.formType === 'teacher').length;
                document.getElementById('professionalsResponses').textContent = JSON.parse(localStorage.getItem('autismSurveyResponses') || '[]').filter(r => r.formType === 'professional').length;
                
                // Mostrar tabela ou mensagem de 'sem dados'
                const responsesTable = document.getElementById('responsesTable');
                const noDataMessage = document.getElementById('noData');
                
                if (responses.length > 0) {
                    responsesTable.style.display = 'table';
                    noDataMessage.style.display = 'none';
                    
                    // Limpar tabela
                    const tbody = responsesTable.querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    // Adicionar cada resposta à tabela
                    responses.forEach(response => {
                        const row = document.createElement('tr');
                        
                        // Data/Hora
                        const dateCell = document.createElement('td');
                        dateCell.textContent = response.submissionDate ? formatDate(response.submissionDate) : 'N/A';
                        
                        // Tipo
                        const typeCell = document.createElement('td');
                        typeCell.textContent = getFormTypeLabel(response.formType);
                        
                        // Nome
                        const nameCell = document.createElement('td');
                        nameCell.textContent = response.name || 'Anônimo';
                        
                        // Email
                        const emailCell = document.createElement('td');
                        emailCell.textContent = response.email || 'N/A';
                        
                        // Ações
                        const actionsCell = document.createElement('td');
                        
                        // Botão Visualizar
                        const viewButton = document.createElement('button');
                        viewButton.className = 'btn';
                        viewButton.textContent = 'Visualizar';
                        viewButton.dataset.id = response.id;
                        viewButton.addEventListener('click', function() {
                            viewResponse(response.id);
                        });
                        
                        // Botão Excluir - Mover para dentro de um menu dropdown para evitar cliques acidentais
                        const deleteContainer = document.createElement('div');
                        deleteContainer.style.display = 'inline-block';
                        deleteContainer.style.position = 'relative';
                        deleteContainer.style.marginLeft = '10px';
                        
                        const moreButton = document.createElement('button');
                        moreButton.className = 'btn';
                        moreButton.textContent = '⋮'; // Três pontos verticais para menu
                        moreButton.style.padding = '5px 10px';
                        
                        const dropdownMenu = document.createElement('div');
                        dropdownMenu.style.display = 'none';
                        dropdownMenu.style.position = 'absolute';
                        dropdownMenu.style.backgroundColor = 'white';
                        dropdownMenu.style.boxShadow = '0px 8px 16px 0px rgba(0,0,0,0.2)';
                        dropdownMenu.style.zIndex = '1';
                        dropdownMenu.style.minWidth = '120px';
                        dropdownMenu.style.right = '0';
                        
                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'btn btn-danger';
                        deleteButton.textContent = 'Excluir';
                        deleteButton.dataset.id = response.id;
                        deleteButton.style.width = '100%';
                        deleteButton.style.textAlign = 'left';
                        deleteButton.style.borderRadius = '0';
                        deleteButton.addEventListener('click', function() {
                            deleteResponse(response.id);
                        });
                        
                        dropdownMenu.appendChild(deleteButton);
                        deleteContainer.appendChild(moreButton);
                        deleteContainer.appendChild(dropdownMenu);
                        
                        // Usar a função centralizada para configurar o dropdown
                        setupDropdownButton(moreButton, dropdownMenu);
                        
                        actionsCell.appendChild(viewButton);
                        actionsCell.appendChild(deleteContainer);
                        
                        // Adicionar células à linha
                        row.appendChild(dateCell);
                        row.appendChild(typeCell);
                        row.appendChild(nameCell);
                        row.appendChild(emailCell);
                        row.appendChild(actionsCell);
                        
                        // Adicionar linha à tabela
                        tbody.appendChild(row);
                    });
                } else {
                    responsesTable.style.display = 'none';
                    noDataMessage.style.display = 'block';
                }
            }
            
            // Função para visualizar detalhes de uma resposta
            function viewResponse(id) {
                const responses = JSON.parse(localStorage.getItem('autismSurveyResponses') || '[]');
                const response = responses.find(r => r.id === id);
                
                if (response) {
                    // Verifique se já existe um detalhe para esta resposta
                    const existingDetail = document.getElementById(`detail-${id}`);
                    if (existingDetail) {
                        existingDetail.remove();
                        return;
                    }
                    
                    // Criar e adicionar o HTML de detalhes
                    const detailHTML = generateDetailHTML(response);
                    
                    // Encontrar a linha da tabela
                    const rows = document.querySelectorAll('#responsesTable tbody tr');
                    let row;
                    for (let i = 0; i < rows.length; i++) {
                        const viewButton = rows[i].querySelector(`button[data-id="${id}"]`);
                        if (viewButton) {
                            row = rows[i];
                            break;
                        }
                    }
                    
                    if (row) {
                        // Criar uma nova linha para os detalhes
                        const detailRow = document.createElement('tr');
                        detailRow.id = `detail-${id}`;
                        detailRow.style.backgroundColor = '#f9f9f9';
                        
                        const detailCell = document.createElement('td');
                        detailCell.colSpan = 5;
                        detailCell.style.padding = '15px';
                        detailCell.innerHTML = detailHTML;
                        
                        detailRow.appendChild(detailCell);
                        
                        // Inserir após a linha da resposta
                        row.parentNode.insertBefore(detailRow, row.nextSibling);
                    }
                }
            }
            
            // Função para excluir uma resposta
            function deleteResponse(id) {
                // Confirmação mais rigorosa para excluir uma resposta
                const confirmText = prompt('Digite "EXCLUIR" (em maiúsculas) para confirmar a exclusão desta resposta:');
                if (confirmText === 'EXCLUIR') {
                    let responses = JSON.parse(localStorage.getItem('autismSurveyResponses') || '[]');
                    responses = responses.filter(r => r.id !== id);
                    localStorage.setItem('autismSurveyResponses', JSON.stringify(responses));
                    loadResponses(document.getElementById('filterType').value);
                    updateAllStats(document.getElementById('statsFilterType').value);
                    alert('Resposta excluída com sucesso.');
                } else {
                    alert('Operação cancelada. A resposta não foi excluída.');
                }
            }
            
            // Gerenciar as abas de estatísticas
            const statsTabs = document.querySelectorAll('.stats-tab');
            
            // Evitar registrar múltiplos event listeners em várias chamadas
            statsTabs.forEach(tab => {
                // Remover event listeners antigos, se existirem
                tab.replaceWith(tab.cloneNode(true));
            });
            
            // Re-selecionar as abas após substituí-las
            const refreshedTabs = document.querySelectorAll('.stats-tab');
            refreshedTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remover classe ativa de todas as abas
                    refreshedTabs.forEach(t => t.classList.remove('active'));
                    // Adicionar classe ativa à aba clicada
                    this.classList.add('active');
                    
                    // Mostrar o painel correspondente
                    const tabName = this.getAttribute('data-tab');
                    const panels = document.querySelectorAll('.stats-panel');
                    panels.forEach(panel => {
                        panel.classList.remove('active');
                    });
                    document.getElementById(`${tabName}-panel`).classList.add('active');
                });
            });
            
            // Atualizar estatísticas quando o filtro mudar
            const statsFilterType = document.getElementById('statsFilterType');
            statsFilterType.removeEventListener('change', updateStatsFromFilter);
            statsFilterType.addEventListener('change', updateStatsFromFilter);
            
            function updateStatsFromFilter() {
                updateAllStats(this.value);
            }
            
            // Função para inicializar e atualizar os gráficos
            function initializeStats() {
                // Configurar atualizações baseadas no filtro
                const filterType = document.getElementById('statsFilterType').value;
                updateAllStats(filterType);
            }
            
            // Atualizar todas as estatísticas com base no filtro
            function updateAllStats(filterType) {
                // Obter as respostas filtradas
                let responses = JSON.parse(localStorage.getItem('autismSurveyResponses') || '[]');
                
                if (filterType !== 'all') {
                    responses = responses.filter(r => r.formType === filterType);
                }
                
                // Atualizar cada tabela de estatísticas
                updateGeneralStats(responses);
                updateProfileStats(responses);
                updateDevelopmentStats(responses);
                updateTechnologyStats(responses);
                updateNeedsStats(responses);
            }
            
            // Funções para atualizar tabelas de estatísticas
            function updateGeneralStats(responses) {
                try {
                    // Contagem por tipo de formulário
                    const typeCounts = {
                        'parent': 0,
                        'teacher': 0,
                        'professional': 0
                    };
                    
                    responses.forEach(r => {
                        if (r.formType in typeCounts) {
                            typeCounts[r.formType]++;
                        }
                    });
                    
                    const typeLabels = {
                        'parent': 'Pais',
                        'teacher': 'Professores',
                        'professional': 'Profissionais'
                    };
                    
                    const tableData = [];
                    for (const [key, label] of Object.entries(typeLabels)) {
                        tableData.push({
                            label: label,
                            value: typeCounts[key] || 0
                        });
                    }
                    
                    // Atualizar tabela de tipos de resposta
                    updateStatsTable('responsesTypeTable', tableData);
                    
                } catch (error) {
                    console.error('Erro ao atualizar estatísticas gerais:', error);
                }
            }
            
            function updateProfileStats(responses) {
                // Tempo de experiência
                const experienceLabels = {
                    'menos_1': 'Menos de 1 ano',
                    '1-3': '1-3 anos',
                    '3-5': '3-5 anos',
                    'mais_5': 'Mais de 5 anos'
                };
                
                const experienceTable = getCountsForTable(responses, 'experience_time', experienceLabels);
                updateStatsTable('experienceTimeTable', experienceTable);
                
                // Familiaridade com tecnologia
                const techFamiliarityLabels = {
                    'beginner': 'Iniciante',
                    'intermediate': 'Intermediário',
                    'advanced': 'Avançado',
                    'expert': 'Especialista'
                };
                
                const familiarityTable = getCountsForTable(responses, 'tech_familiarity', techFamiliarityLabels);
                updateStatsTable('techFamiliarityTable', familiarityTable);
            }
            
            function updateDevelopmentStats(responses) {
                // Dificuldades de aprendizagem
                const learningLabels = {
                    'communication': 'Comunicação',
                    'math': 'Matemática',
                    'reading_writing': 'Leitura/Escrita',
                    'social_skills': 'Habilidades sociais',
                    'concentration': 'Concentração',
                    'organization': 'Organização',
                    'following_instructions': 'Seguir instruções'
                };
                
                const learningTable = getArrayCountsForTable(responses, 'learning_difficulties', learningLabels);
                updateStatsTable('learningDifficultiesTable', learningTable);
                
                // Reação a mudanças
                const routineLabels = {
                    'very_adaptable': 'Muito adaptável',
                    'adapts_with_time': 'Adapta com tempo',
                    'difficult_adaptation': 'Difícil adaptação',
                    'negative_reaction': 'Reação negativa',
                    'varied': 'Variado'
                };
                
                const routineTable = getCountsForTable(responses, 'routine_changes', routineLabels);
                updateStatsTable('routineChangesTable', routineTable);
            }
            
            function updateTechnologyStats(responses) {
                // Dispositivos
                const devicesLabels = {
                    'tablet': 'Tablet',
                    'computer': 'Computador',
                    'smartphone': 'Smartphone',
                    'smartboard': 'Lousa digital',
                    'projector': 'Projetor',
                    'aac_device': 'Comunicação alternativa',
                    'smarttv': 'Smart TV',
                    'none': 'Nenhum'
                };
                
                const devicesTable = getArrayCountsForTable(responses, 'devices', devicesLabels);
                updateStatsTable('devicesTable', devicesTable);
                
                // Eficácia
                const efficacyLabels = {
                    'very_effective': 'Muito eficaz',
                    'moderately_effective': 'Moderadamente eficaz',
                    'slightly_effective': 'Pouco eficaz',
                    'not_effective': 'Não eficaz',
                    'do_not_use': 'Não utiliza'
                };
                
                const efficacyTable = getCountsForTable(responses, 'tech_efficacy', efficacyLabels);
                updateStatsTable('techEfficacyTable', efficacyTable);
            }
            
            function updateNeedsStats(responses) {
                // Recursos importantes
                const featuresLabels = {
                    'personalization': 'Personalização',
                    'adaptive': 'Interface adaptativa',
                    'feedback': 'Feedback em tempo real',
                    'progress_reports': 'Relatórios de progresso',
                    'visuals': 'Recursos visuais',
                    'interactivity': 'Interatividade',
                    'different_levels': 'Diferentes níveis',
                    'lesson_plans': 'Planos de aula',
                    'teacher_guides': 'Guias para professores',
                    'parent_connection': 'Conexão com pais'
                };
                
                const featuresTable = getArrayCountsForTable(responses, 'important_features', featuresLabels);
                updateStatsTable('importantFeaturesTable', featuresTable);
                
                // Suporte desejado
                const supportLabels = {
                    'training': 'Treinamento',
                    'resources': 'Recursos',
                    'tech_tools': 'Ferramentas tecnológicas',
                    'smaller_classes': 'Turmas menores',
                    'assistant': 'Assistente',
                    'specialist_support': 'Suporte especializado',
                    'parent_collaboration': 'Colaboração com pais',
                    'curriculum_guidelines': 'Diretrizes curriculares',
                    'technical_support': 'Suporte técnico',
                    'guidelines': 'Manuais/Diretrizes',
                    'specialized_tools': 'Ferramentas especializadas',
                    'research': 'Mais pesquisas',
                    'community': 'Comunidade de prática'
                };
                
                // Verificar qual campo existe nos dados
                let supportField = 'support_needed';
                if (responses.some(r => r.desired_support)) {
                    supportField = 'desired_support';
                }
                
                const supportTable = getArrayCountsForTable(responses, supportField, supportLabels);
                updateStatsTable('desiredSupportTable', supportTable);
            }
            
            // Funções utilitárias para estatísticas
            function getCountsForTable(responses, field, labels = null) {
                const counts = {};
                responses.forEach(response => {
                    const value = response[field];
                    if (value) {
                        counts[value] = (counts[value] || 0) + 1;
                    }
                });
                
                // Preparar dados para a tabela
                const tableData = [];
                
                if (labels) {
                    // Usar rótulos predefinidos, se fornecidos
                    for (const [key, label] of Object.entries(labels)) {
                        tableData.push({
                            label: label,
                            value: counts[key] || 0
                        });
                    }
                } else {
                    // Usar valores diretamente como rótulos
                    for (const [key, count] of Object.entries(counts)) {
                        tableData.push({
                            label: key,
                            value: count
                        });
                    }
                }
                
                // Ordenar por contagem (maior primeiro)
                tableData.sort((a, b) => b.value - a.value);
                
                return tableData;
            }
            
            function getArrayCountsForTable(responses, field, labels = null) {
                const counts = {};
                responses.forEach(response => {
                    const values = response[field];
                    if (Array.isArray(values)) {
                        values.forEach(value => {
                            counts[value] = (counts[value] || 0) + 1;
                        });
                    }
                });
                
                // Preparar dados para a tabela
                const tableData = [];
                
                if (labels) {
                    // Usar rótulos predefinidos, se fornecidos
                    for (const [key, label] of Object.entries(labels)) {
                        if (key in counts) {
                            tableData.push({
                                label: label,
                                value: counts[key] || 0
                            });
                        }
                    }
                } else {
                    // Usar valores diretamente como rótulos
                    for (const [key, count] of Object.entries(counts)) {
                        tableData.push({
                            label: key,
                            value: count
                        });
                    }
                }
                
                // Ordenar por contagem (maior primeiro)
                tableData.sort((a, b) => b.value - a.value);
                
                return tableData;
            }
            
            function updateStatsTable(tableId, data) {
                const table = document.getElementById(tableId);
                if (!table) return;
                
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 2;
                    cell.textContent = 'Sem dados disponíveis';
                    cell.style.textAlign = 'center';
                    cell.style.fontStyle = 'italic';
                    row.appendChild(cell);
                    tbody.appendChild(row);
                    return;
                }
                
                // Adicionar cada linha à tabela
                data.forEach(item => {
                    const row = document.createElement('tr');
                    
                    const labelCell = document.createElement('td');
                    labelCell.textContent = item.label;
                    
                    const valueCell = document.createElement('td');
                    valueCell.textContent = item.value;
                    valueCell.className = 'count';
                    valueCell.style.textAlign = 'center';
                    
                    row.appendChild(labelCell);
                    row.appendChild(valueCell);
                    tbody.appendChild(row);
                });
            }
            
            // Função para formatar data para nome de arquivo
            function formatDateForFilename(date) {
                return date.toISOString().split('T')[0].replace(/-/g, '');
            }
            
            // Função de exportação JSON
            function exportJSON() {
                const filterType = document.getElementById('filterType').value;
                let responses = JSON.parse(localStorage.getItem('autismSurveyResponses') || '[]');
                
                if (filterType !== 'all') {
                    responses = responses.filter(r => r.formType === filterType);
                }
                
                if (responses.length === 0) {
                    alert('Não há respostas para exportar.');
                    return;
                }
                
                // Adicionar metadados
                const exportData = {
                    exportDate: new Date().toISOString(),
                    exportedBy: 'Administrador',
                    version: '1.0',
                    responses: responses
                };
                
                // Converter para JSON
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // Criar blob e link de download
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `respostas_autismo_${filterType}_${formatDateForFilename(new Date())}.json`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // Função de importação JSON
            function importJSON() {
                const fileInput = document.getElementById('importFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Por favor, selecione um arquivo JSON para importar.');
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // Verificar se o arquivo tem o formato esperado
                        if (!importedData.responses || !Array.isArray(importedData.responses)) {
                            throw new Error('Formato de arquivo inválido. Não foi possível encontrar as respostas.');
                        }
                        
                        // Obter respostas atuais
                        let currentResponses = JSON.parse(localStorage.getItem('autismSurveyResponses') || '[]');
                        const currentIds = new Set(currentResponses.map(r => r.id));
                        
                        // Filtrar apenas novas respostas para evitar duplicações
                        const newResponses = importedData.responses.filter(r => !currentIds.has(r.id));
                        
                        if (newResponses.length === 0) {
                            alert('Nenhuma nova resposta para importar. Todas as respostas deste arquivo já existem na base de dados.');
                            return;
                        }
                        
                        // Adicionar novas respostas
                        const updatedResponses = [...currentResponses, ...newResponses];
                        
                        // Salvar no localStorage
                        localStorage.setItem('autismSurveyResponses', JSON.stringify(updatedResponses));
                        
                        // Recarregar dados
                        loadResponses(document.getElementById('filterType').value);
                        updateAllStats(document.getElementById('statsFilterType').value);
                        
                        // Mensagem de sucesso
                        alert(`Importação concluída com sucesso! ${newResponses.length} novas respostas foram adicionadas.`);
                        
                        // Limpar o campo de arquivo
                        fileInput.value = '';
                        
                    } catch (error) {
                        console.error('Erro na importação:', error);
                        alert('Erro ao importar o arquivo: ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    alert('Erro ao ler o arquivo. Por favor, tente novamente.');
                };
                
                reader.readAsText(file);
            }
            
            // Adicionando função para gerar detalhes da resposta
            function generateDetailHTML(response) {
                let html = '<div class="response-detail" style="display:block;">';
                
                // Agrupar dados por seção
                const sections = {
                    "Informações Gerais": ['name', 'email', 'formType', 'submissionDate'],
                    "Perfil": ['profession', 'experience_time', 'location', 'location_other', 'school_type', 'specialized_training', 
                              'tech_familiarity', 'autism_students', 'autism_children'],
                    "Características": ['children_age', 'students_age', 'autism_level', 'characteristics', 
                                      'development_needs', 'school_support'],
                    "Aprendizagem": ['learning_difficulties', 'interests', 'teaching_methods', 'routine_changes', 
                                   'curriculum_adaptations', 'therapeutic_approaches', 'professional_challenges',
                                   'teacher_challenges', 'effective_interventions'],
                    "Tecnologia": ['devices', 'tech_devices', 'tech_resources', 'tech_frequency', 'tech_purpose', 
                                 'tech_efficacy', 'tech_aspects', 'tech_barriers', 'tech_effectiveness'],
                    "Necessidades": ['important_features', 'concerns', 'desired_support', 'unmet_needs', 
                                   'teacher_desired_tools', 'platform_essentials', 'suggestions', 'desired_tools',
                                   'support_needed', 'improvement_suggestions']
                };
                
                // Adicionar cada seção
                for (const [section, fields] of Object.entries(sections)) {
                    let sectionHasData = false;
                    let sectionHTML = `<div class="detail-group"><h4>${section}</h4>`;
                    
                    for (const field of fields) {
                        if (response[field] !== undefined && response[field] !== null && response[field] !== '') {
                            sectionHasData = true;
                            let value = response[field];
                            
                            // Formatar arrays
                            if (Array.isArray(value)) {
                                value = value.join(', ');
                            }
                            
                            // Formatar data
                            if (field === 'submissionDate') {
                                value = formatDate(value);
                            }
                            
                            // Formatar tipo de formulário
                            if (field === 'formType') {
                                value = getFormTypeLabel(value);
                            }
                            
                            sectionHTML += `<p><strong>${getFieldLabel(field)}:</strong> ${value}</p>`;
                        }
                    }
                    
                    sectionHTML += '</div>';
                    
                    if (sectionHasData) {
                        html += sectionHTML;
                    }
                }
                
                html += '</div>';
                return html;
            }
            
            // Função para obter rótulo do tipo de formulário
            function getFormTypeLabel(type) {
                const labels = {
                    'parent': 'Pais',
                    'teacher': 'Professores',
                    'professional': 'Profissionais'
                };
                return labels[type] || type;
            }
            
            // Função para obter rótulo dos campos
            function getFieldLabel(field) {
                const labels = {
                    'name': 'Nome',
                    'email': 'E-mail',
                    'formType': 'Tipo de Formulário',
                    'submissionDate': 'Data de Envio',
                    'profession': 'Profissão',
                    'experience_time': 'Tempo de Experiência',
                    'location': 'Localização',
                    'location_other': 'Localização (Especificada)',
                    'tech_familiarity': 'Familiaridade com Tecnologia',
                    'autism_students': 'Qtd. Alunos com Autismo',
                    'autism_children': 'Qtd. Crianças com Autismo',
                    'school_type': 'Tipo de Escola',
                    'specialized_training': 'Formação Especializada',
                    'children_age': 'Faixa Etária das Crianças',
                    'students_age': 'Faixa Etária dos Alunos',
                    'autism_level': 'Nível de Autismo',
                    'characteristics': 'Características',
                    'development_needs': 'Necessidades de Desenvolvimento',
                    'school_support': 'Apoio Escolar',
                    'learning_difficulties': 'Dificuldades de Aprendizagem',
                    'interests': 'Interesses',
                    'teaching_methods': 'Métodos de Ensino',
                    'routine_changes': 'Reação a Mudanças',
                    'curriculum_adaptations': 'Adaptações Curriculares',
                    'therapeutic_approaches': 'Abordagens Terapêuticas',
                    'professional_challenges': 'Desafios Profissionais',
                    'teacher_challenges': 'Desafios do Professor',
                    'effective_interventions': 'Intervenções Eficazes',
                    'devices': 'Dispositivos',
                    'tech_devices': 'Dispositivos Tecnológicos',
                    'tech_resources': 'Recursos Tecnológicos',
                    'tech_frequency': 'Frequência de Uso',
                    'tech_purpose': 'Objetivo do Uso',
                    'tech_efficacy': 'Eficácia da Tecnologia',
                    'tech_aspects': 'Aspectos da Tecnologia',
                    'tech_barriers': 'Barreiras Tecnológicas',
                    'tech_effectiveness': 'Efetividade da Tecnologia',
                    'important_features': 'Recursos Importantes',
                    'concerns': 'Preocupações',
                    'desired_support': 'Apoio Desejado',
                    'unmet_needs': 'Necessidades Não Atendidas',
                    'teacher_desired_tools': 'Ferramentas Desejadas pelo Professor',
                    'platform_essentials': 'Essenciais da Plataforma',
                    'suggestions': 'Sugestões',
                    'desired_tools': 'Ferramentas Desejadas',
                    'support_needed': 'Suporte Necessário',
                    'improvement_suggestions': 'Sugestões de Melhoria'
                };
                return labels[field] || field;
            }
            
            // Função para formatar data
            function formatDate(dateString) {
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return dateString;
                }
            }
            
            // Função para exportar CSV corrigida
            function exportCSV() {
                try {
                    const filterType = document.getElementById('filterType').value;
                    let responses = JSON.parse(localStorage.getItem('autismSurveyResponses') || '[]');
                    
                    if (filterType !== 'all') {
                        responses = responses.filter(r => r.formType === filterType);
                    }
                    
                    if (responses.length === 0) {
                        alert('Não há respostas para exportar.');
                        return;
                    }
                    
                    // Converter para CSV
                    const csv = convertToCSV(responses);
                    
                    // Criar blob com BOM para UTF-8
                    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8' });
                    
                    // Usar URL.createObjectURL para criar um link para o blob
                    const url = URL.createObjectURL(blob);
                    
                    // Criar um elemento de link para download
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `respostas_autismo_${filterType}_${formatDateForFilename(new Date())}.csv`;
                    document.body.appendChild(link);
                    
                    // Simular clique para iniciar o download
                    link.click();
                    
                    // Limpar
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    console.log('Exportação CSV realizada com sucesso');
                } catch (error) {
                    console.error('Erro na exportação CSV:', error);
                    alert(`Erro ao exportar para CSV: ${error.message}`);
                }
            }
            
            // Função para converter para CSV
            function convertToCSV(responses) {
                if (!responses || responses.length === 0) return '';
                
                try {
                    // Coletar todos os cabeçalhos possíveis
                    const headers = new Set();
                    responses.forEach(response => {
                        Object.keys(response).forEach(key => headers.add(key));
                    });
                    
                    const headersArray = Array.from(headers);
                    
                    // Criar linha de cabeçalho com nomes amigáveis
                    const headerRow = headersArray.map(header => getFieldLabel(header)).join(';');
                    
                    // Criar linhas de dados
                    const rows = responses.map(response => {
                        return headersArray.map(header => {
                            const value = response[header];
                            if (value === undefined || value === null) return '';
                            
                            // Lidar com arrays
                            if (Array.isArray(value)) {
                                return `"${value.join(' | ')}"`;
                            }
                            
                            // Formatar tipo de formulário
                            if (header === 'formType') {
                                return `"${getFormTypeLabel(value)}"`;
                            }
                            
                            // Formatar data
                            if (header === 'submissionDate') {
                                return `"${formatDate(value)}"`;
                            }
                            
                            // Escapar texto para CSV
                            if (typeof value === 'string') {
                                return `"${value.replace(/"/g, '""')}"`;
                            }
                            
                            return `"${value}"`;
                        }).join(';');
                    });
                    
                    return headerRow + '\r\n' + rows.join('\r\n');
                } catch (error) {
                    console.error('Erro ao converter para CSV:', error);
                    throw new Error('Falha ao converter dados para CSV: ' + error.message);
                }
            }

            // Fechar dropdown quando clicar fora
            document.addEventListener('click', function() {
                const dropdowns = document.querySelectorAll('[data-dropdown-open="true"]');
                dropdowns.forEach(menu => {
                    menu.style.display = 'none';
                    menu.removeAttribute('data-dropdown-open');
                });
            });

            // Adicionar evento para mostrar/ocultar dropdown
            function setupDropdownButton(moreButton, dropdownMenu) {
                moreButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Fechar todos outros dropdowns
                    const openDropdowns = document.querySelectorAll('[data-dropdown-open="true"]');
                    openDropdowns.forEach(menu => {
                        if (menu !== dropdownMenu) {
                            menu.style.display = 'none';
                            menu.removeAttribute('data-dropdown-open');
                        }
                    });
                    
                    // Alternar este dropdown
                    if (dropdownMenu.style.display === 'none') {
                        dropdownMenu.style.display = 'block';
                        dropdownMenu.setAttribute('data-dropdown-open', 'true');
                    } else {
                        dropdownMenu.style.display = 'none';
                        dropdownMenu.removeAttribute('data-dropdown-open');
                    }
                });
            }
        });
    </script>
</body>
</html> 
